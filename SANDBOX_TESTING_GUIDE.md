# Sandbox（サンドボックス）テスト設定ガイド

このガイドでは、iOSアプリのサブスクリプション（課金）機能をテストするための「Sandbox環境」の設定方法を、初心者の方にもわかりやすく解説します。

---

## Sandboxとは？

**Sandbox（サンドボックス）**は、Appleが提供するテスト用の課金環境です。

### なぜSandboxが必要？

- **本番課金されない**: テスト中に実際のお金が引き落とされません
- **高速テスト**: サブスクリプションの更新期間が短縮されます
  - 3日間 → 約3分間
  - 1ヶ月 → 約5分間
  - 1年 → 約1時間
- **何度でもテスト可能**: 購入をリセットして繰り返しテストできます

---

## 設定手順

### ステップ1: App Store Connectにログイン

1. Webブラウザで以下のURLにアクセス
   ```
   https://appstoreconnect.apple.com/
   ```

2. Apple Developer Programに登録したApple IDでログイン

---

### ステップ2: Sandboxテスターアカウントを作成

#### 2-1. テスター管理画面を開く

1. App Store Connectのトップページで「ユーザーとアクセス」をクリック
2. 左側のメニューから「Sandbox」→「テスター」を選択

#### 2-2. 新しいテスターを追加

1. 「+」ボタンをクリック
2. 以下の情報を入力:

| 項目 | 入力例 | 説明 |
|------|--------|------|
| 名 | Test | テスト用の名前（何でもOK） |
| 姓 | User | テスト用の姓（何でもOK） |
| メールアドレス | **test+sandbox@gmail.com** | ※重要：下記参照 |
| パスワード | TestPass123! | 8文字以上、英大文字・小文字・数字を含む |
| 秘密の質問 | 任意の質問を選択 | パスワードリセット用 |
| 回答 | 任意の回答 | 覚えやすいもの |
| 国/地域 | 日本 | テストしたい地域 |

3. 「招待」ボタンをクリック

#### メールアドレスについての重要な注意

**実際に存在するメールアドレスは使用しないでください！**

Sandboxテスター用のメールアドレスは、Appleのシステム内でのみ使用される仮想アドレスです。
実際にメールが届くことはありません。

**推奨される方法:**

- Gmailの「+」記法を使う: `yourmail+sandbox1@gmail.com`
  - この場合、確認メールは `yourmail@gmail.com` に届きます
- 完全に架空のアドレス: `sandbox-test-001@example.com`
  - 確認不要で使用可能

---

### ステップ3: iPhoneでSandboxアカウントを設定

テストに使用するiPhoneで、Sandboxアカウントを設定します。

#### 3-1. App Storeからサインアウト（任意）

通常のApp Storeアカウントはサインアウト不要です。
Sandboxは別の仕組みで動作します。

#### 3-2. Sandboxアカウントを追加

**iOS 14以降の場合:**

1. iPhoneの「設定」アプリを開く
2. 「App Store」をタップ
3. 一番下までスクロール
4. 「サンドボックスアカウント」セクションを探す
5. 「サインイン」をタップ
6. ステップ2で作成したメールアドレスとパスワードを入力
7. 「サインイン」をタップ

**iOS 13以前の場合:**

1. アプリ内で課金を試みると、Sandboxログイン画面が表示されます
2. その時にSandboxアカウントでログインします

#### 3-3. 確認

設定が完了すると、「設定」→「App Store」の下部に:
```
サンドボックスアカウント
test+sandbox@gmail.com
```
と表示されます。

---

### ステップ4: アプリでテスト購入を実行

#### 4-1. アプリをビルド・実行

1. Xcodeでプロジェクトを開く
2. 実機（iPhone）を接続
3. 実機を選択してビルド・実行

**重要**: シミュレータではなく、実機でテストしてください。
シミュレータではApp Store課金のテストができません。

#### 4-2. サブスクリプションを購入

1. アプリ内でプレミアムプランの画面を開く
2. プランを選択して「購入する」をタップ
3. Sandboxの購入確認ダイアログが表示される
4. 「購入」をタップ
5. Sandboxアカウントのパスワードを入力（必要な場合）

#### 4-3. 購入完了の確認

- 購入が成功すると、アプリ内で「購入が完了しました！」と表示されます
- 失敗した場合は、エラーメッセージを確認してください

---

## トラブルシューティング

### 「利用可能なプランがありません」と表示される

**原因1: App Store Connectでサブスクリプションが未設定**

App Store Connectでサブスクリプション商品を作成する必要があります。

**対処法:**
1. App Store Connect →「マイApp」→ アプリを選択
2. 「機能」タブ →「サブスクリプション」
3. サブスクリプショングループを作成
4. 各プランを追加（月額・年額）

**原因2: RevenueCatの設定が不完全**

RevenueCatダッシュボードでの設定を確認してください。

**対処法:**
1. RevenueCat Dashboard にログイン
2. プロジェクト → iOS App を選択
3. 「Products」でプロダクトIDを確認
4. 「Offerings」で商品が正しく設定されているか確認

**原因3: ネットワーク接続の問題**

**対処法:**
- Wi-Fiまたはモバイルデータ通信を確認
- 機内モードをON/OFFしてみる
- アプリを再起動

---

### 購入がキャンセルされる

**原因1: Sandboxアカウントが設定されていない**

**対処法:**
- 「設定」→「App Store」→「サンドボックスアカウント」を確認
- サインインされていない場合は、ステップ3を実行

**原因2: Apple IDのパスワードが間違っている**

**対処法:**
- Sandboxアカウントのパスワードを再確認
- App Store Connectでパスワードをリセット

---

### 「この Apple ID はテスト環境で使用できません」

**原因**: 通常のApple IDでSandbox購入しようとしている

**対処法:**
- Sandboxテスター専用のアカウントを使用してください
- 通常のApple IDはSandboxでは使用できません

---

### 購入後も機能がアンロックされない

**原因1: RevenueCatとの同期遅延**

**対処法:**
- 数秒待ってから「購入情報を復元」を試す
- アプリを再起動

**原因2: Webhook設定の問題**

**対処法:**
- RevenueCatダッシュボードでWebhook設定を確認
- Firebaseとの連携が正しく設定されているか確認

---

## Sandboxでのテスト時間

Sandbox環境では、サブスクリプションの期間が短縮されます：

| 実際の期間 | Sandboxでの期間 |
|-----------|----------------|
| 3日間（トライアル） | 約3分 |
| 1週間 | 約3分 |
| 1ヶ月 | 約5分 |
| 2ヶ月 | 約10分 |
| 3ヶ月 | 約15分 |
| 6ヶ月 | 約30分 |
| 1年 | 約1時間 |

### 自動更新について

- Sandboxでは、サブスクリプションは**最大6回**自動更新されます
- 6回更新後、自動的にキャンセルされます
- 再度テストする場合は、新しいSandboxアカウントを作成するか、しばらく待ってから再試行してください

---

## テストシナリオ例

### シナリオ1: 新規ユーザーの無料トライアル開始

1. 新しいSandboxアカウントでサインイン
2. アプリで月額プランを選択
3. 3日間無料トライアルが開始されることを確認
4. 約3分後にトライアルが終了し、有料期間に移行することを確認

### シナリオ2: 購入情報の復元

1. 購入済みのSandboxアカウントでサインイン
2. アプリを再インストール
3. 「購入情報を復元」ボタンをタップ
4. プレミアム機能がアンロックされることを確認

### シナリオ3: サブスクリプションのキャンセル

1. 購入済みの状態で「設定」→「Apple ID」→「サブスクリプション」
2. アプリのサブスクリプションを選択
3. 「サブスクリプションをキャンセル」
4. 次回更新時に課金されないことを確認

---

## RevenueCatでのテスト確認

### RevenueCatダッシュボードで購入を確認

1. RevenueCat Dashboard にログイン
   ```
   https://app.revenuecat.com/
   ```

2. プロジェクトを選択

3. 「Customers」タブをクリック

4. SandboxアカウントのApp User IDを検索

5. 購入履歴、サブスクリプション状態を確認

### デバッグログの確認

アプリ実行中、Xcodeのコンソールに以下のようなログが表示されます：

```
🔵 Offerings読み込み開始
🟢 Offerings取得成功: {default: ...}
🟢 Current offering: default
🟢 Monthly package: $rc_monthly
🟢 Annual package: $rc_annual
```

エラーがある場合：
```
🔴 Offerings取得エラー: ...
```

---

## よくある質問

### Q: 実機がなくてもテストできますか？

**A**: 残念ながら、App Store課金のテストには実機が必要です。
シミュレータではSandbox購入をテストできません。

### Q: Sandboxアカウントは何個作れますか？

**A**: 制限はありません。必要に応じて複数作成できます。

### Q: 購入をリセットしたい場合は？

**A**: 新しいSandboxアカウントを作成するのが最も簡単です。
または、24時間以上待つと同じアカウントで再テスト可能になることがあります。

### Q: 本番環境と同じ動作ですか？

**A**: 基本的には同じですが、以下の違いがあります：
- 期間が短縮される
- 自動更新は最大6回
- 実際の課金は発生しない

### Q: テスト中に本番のApple IDで課金されることはありますか？

**A**: いいえ。開発ビルド（Xcodeから直接インストール）では、
自動的にSandbox環境が使用されます。
TestFlightビルドでも同様です。

---

## 次のステップ

Sandboxテストが完了したら：

1. **TestFlightにアップロード**: `TESTFLIGHT_UPLOAD.md` 参照
2. **内部テスター招待**: チームメンバーに配布してテスト
3. **外部テスター招待**: より多くのユーザーでテスト
4. **App Store申請**: 最終確認後、審査に提出

---

## 参考リンク

- [Apple公式: Sandbox Testing](https://developer.apple.com/documentation/storekit/in-app_purchase/testing_in-app_purchases_in_sandbox/)
- [RevenueCat: Testing Guide](https://www.revenuecat.com/docs/test-and-launch/sandbox/)
- [App Store Connect ヘルプ](https://help.apple.com/app-store-connect/)

---

最終更新: 2026年1月4日
